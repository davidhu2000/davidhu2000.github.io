---
import { SITE } from "../../../config";
import PageLayout from "../../../layouts/PageLayout.astro";
import BlogList from "../../../layouts/BlogList.astro";
import type { IStaticPathProps } from "../../../helpers/staticPathProps";
import { getPosts } from "../../../helpers/getPosts";

export async function getStaticPaths({ paginate }: IStaticPathProps) {
  const posts = getPosts();

  const tags = new Set<string>();
  posts.forEach((post) => {
    post.frontmatter.tags.forEach((tag) => tags.add(tag.toLowerCase()));
  });

  return Array.from(tags).map((tag) => {
    return paginate(
      posts.filter((post) => post.frontmatter.tags.includes(tag)),
      {
        params: { tag, tags: "tag" },
        pageSize: SITE.postsPerPage,
        props: { tag },
      }
    );
  });
}

const { page, tag } = Astro.props;

const currentPage = page.currentPage ?? 1;

const meta = {
  title: `Posts by tag '${tag}' ${
    currentPage > 1 ? `— Page ${currentPage} ` : ""
  }— ${SITE.name}`,
  description: SITE.description,
  canonical: Astro.url,
};
---

<PageLayout meta={meta}>
  <BlogList title={`Tag: ${tag}`} page={page} />
</PageLayout>
