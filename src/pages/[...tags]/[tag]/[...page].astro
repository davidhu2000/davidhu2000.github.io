---
import type { GetStaticPathsOptions } from "astro";

import { SITE } from "../../../config";

import type { IPageProps } from "../../../helpers/staticPathProps";
import BlogList from "../../../layouts/BlogList.astro";
import PageLayout from "../../../layouts/PageLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const posts = await getCollection("blog");

  const tags = new Set<string>();
  posts.forEach((post) => {
    post.data.tags.forEach((tag) => tags.add(tag.toLowerCase()));
  });

  return Array.from(tags).flatMap((tag) => {
    return paginate(
      posts.filter((post) => post.data.tags.includes(tag)),
      {
        params: { tag, tags: "tag" },
        pageSize: SITE.postsPerPage,
        props: { tag },
      }
    );
  });
}

interface Props extends IPageProps {
  tag: string;
}

const { page, tag } = Astro.props;

const currentPage = page.currentPage ?? 1;

const meta = {
  title: `Posts by tag '${tag}' ${currentPage > 1 ? `— Page ${currentPage} ` : ""}— ${SITE.name}`,
  description: SITE.description,
  canonical: Astro.url,
};
---

<PageLayout meta={meta}>
  <BlogList title={`Tag: ${tag}`} page={page} />
</PageLayout>
